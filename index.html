<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Симулятор кейсов с фигурками</title>
    <style>
        :root {
            --primary-color: #ffcc00;
            --secondary-color: #ff6b00;
            --dark-bg: #1a1a1a;
            --darker-bg: #121212;
            --item-bg: #333;
            --success-color: #33cc33;
            --danger-color: #ff3333;
            --rare-color: #4d88ff;
            --epic-color: #b347ea;
            --legendary-color: #ffaa00;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-bg);
            color: white;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
            font-size: 2.5rem;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            background-color: #333;
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: #1a1a1a;
        }
        
        .tab:hover:not(.active) {
            background-color: #444;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .balance {
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .balance-item {
            display: flex;
            align-items: center;
        }
        
        .balance-icon {
            font-size: 1.2rem;
            margin-right: 8px;
            color: var(--primary-color);
        }
        
        .cases-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .case {
            background: linear-gradient(145deg, #3a3a3a, #2e2e2e);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            border: 2px solid #444;
        }
        
        .case:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            border-color: var(--primary-color);
        }
        
        .case::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0) 30%,
                rgba(255, 255, 255, 0.1) 45%,
                rgba(255, 255, 255, 0) 60%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(30deg);
            transition: all 0.5s;
        }
        
        .case:hover::before {
            left: 100%;
            top: 100%;
        }
        
        .case-img-container {
            position: relative;
            width: 100%;
            height: 180px;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #222;
        }
        
        .case img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .case:hover img {
            transform: scale(1.05);
        }
        
        .case h3 {
            margin: 10px 0 5px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .case .price {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 5px;
        }
        
        .case .limited {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--danger-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .rarity {
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .common { background-color: #aaa; color: #333; }
        .rare { background-color: var(--rare-color); color: white; }
        .epic { background-color: var(--epic-color); color: white; }
        .legendary { background-color: var(--legendary-color); color: #333; }
        
        .animation-container {
            height: 200px;
            overflow: hidden;
            position: relative;
            margin: 30px 0;
            background-color: #222;
            border-radius: 10px;
            display: none;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .animation-items {
            display: flex;
            position: absolute;
            left: 0;
            transition: left 0.1s;
            height: 100%;
        }
        
        .animation-item {
            width: 180px;
            height: 100%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #333;
            margin-right: 5px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            border: 2px solid #444;
        }
        
        .animation-item.highlight {
            animation: highlight 0.5s infinite alternate;
        }
        
        @keyframes highlight {
            from { border-color: #444; box-shadow: none; }
            to { border-color: var(--primary-color); box-shadow: 0 0 20px var(--primary-color); }
        }
        
        .animation-item img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            transition: transform 0.3s;
        }
        
        .animation-item .name {
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            padding: 0 5px;
        }
        
        .result {
            text-align: center;
            margin: 30px 0;
            font-size: 28px;
            color: var(--primary-color);
            display: none;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            display: none;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sell-btn {
            background-color: var(--danger-color);
            color: white;
        }
        
        .sell-btn:hover {
            background-color: #e60000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 51, 51, 0.4);
        }
        
        .keep-btn {
            background-color: var(--success-color);
            color: white;
        }
        
        .keep-btn:hover {
            background-color: #29a329;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(51, 204, 51, 0.4);
        }
        
        .inventory-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }
        
        .inventory-item {
            background: linear-gradient(145deg, #3a3a3a, #2e2e2e);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            border: 2px solid #444;
        }
        
        .inventory-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .inventory-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 2px solid #444;
        }
        
        .inventory-item .name {
            font-size: 14px;
            margin: 5px 0;
            font-weight: bold;
        }
        
        .inventory-item .price {
            color: var(--primary-color);
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .inventory-item .level {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--primary-color);
            color: #333;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        
        .item-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .sell-inventory-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
            margin-right: 5px;
            transition: all 0.3s;
        }
        
        .sell-inventory-btn:hover {
            background-color: #e60000;
        }
        
        .upgrade-inventory-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s;
        }
        
        .upgrade-inventory-btn:hover {
            background-color: #e05d00;
        }
        
        .upgrade-container {
            background-color: #333;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .upgrade-info {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #444;
            border-radius: 8px;
        }
        
        .upgrade-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #444;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .upgrade-item:hover {
            background-color: #555;
        }
        
        .upgrade-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
            border: 2px solid #555;
        }
        
        .upgrade-item-info {
            flex: 1;
        }
        
        .upgrade-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .upgrade-item-stats {
            display: flex;
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .upgrade-item-price {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .upgrade-item-chance {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .upgrade-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .upgrade-btn:hover {
            background-color: #e05d00;
            transform: translateY(-2px);
        }
        
        .upgrade-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--primary-color);
            opacity: 0;
            animation: confetti-fall 5s linear forwards;
            z-index: 1000;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: #333;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
            animation: modalAppear 0.5s;
        }
        
        @keyframes modalAppear {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .modal-text {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #444;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            width: 0%;
            transition: width 1s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .cases-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .inventory-items {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }
            
            .animation-item {
                width: 150px;
            }
            
            .animation-item img {
                width: 100px;
                height: 100px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>✨ Симулятор кейсов с фигурками ✨</h1>
        
        <div class="balance">
            <div class="balance-item">
                <span class="balance-icon">💰</span>
                Баланс: <span id="money">1000</span> ₽
            </div>
            <div class="balance-item">
                <span class="balance-icon">🎁</span>
                Открыто: <span id="opened-cases">0</span>
            </div>
            <div class="balance-item">
                <span class="balance-icon">🔑</span>
                Ключи: <span id="keys">0</span>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="openTab('cases-tab')">Кейсы</button>
            <button class="tab" onclick="openTab('inventory-tab')">Инвентарь</button>
            <button class="tab" onclick="openTab('upgrade-tab')">Апгрейд</button>
        </div>
        
        <div id="cases-tab" class="tab-content active">
            <h2>Доступные кейсы</h2>
            <div class="cases-container">
                <div class="case" onclick="openCase(0)">
                    <div class="case-img-container">
                        <img src="https://via.placeholder.com/300/aaa/000?text=Обычный" alt="Обычный кейс">
                        <div class="rarity common">Обычный</div>
                    </div>
                    <h3>Обычный кейс</h3>
                    <div class="price">100 ₽</div>
                </div>
                
                <div class="case" onclick="openCase(1)">
                    <div class="case-img-container">
                        <img src="https://via.placeholder.com/300/4d88ff/fff?text=Редкий" alt="Редкий кейс">
                        <div class="rarity rare">Редкий</div>
                    </div>
                    <h3>Редкий кейс</h3>
                    <div class="price">300 ₽</div>
                </div>
                
                <div class="case" onclick="openCase(2)">
                    <div class="case-img-container">
                        <img src="https://via.placeholder.com/300/b347ea/fff?text=Эпический" alt="Эпический кейс">
                        <div class="rarity epic">Эпический</div>
                    </div>
                    <h3>Эпический кейс</h3>
                    <div class="price">500 ₽</div>
                    <div class="limited">Осталось: <span id="limited-count">5</span></div>
                </div>
                
                <div class="case" onclick="openCase(3)">
                    <div class="case-img-container">
                        <img src="https://via.placeholder.com/300/ffaa00/000?text=Легендарный" alt="Легендарный кейс">
                        <div class="rarity legendary">Легендарный</div>
                    </div>
                    <h3>Легендарный кейс</h3>
                    <div class="price">1000 ₽</div>
                    <div class="limited">Осталось: <span id="legendary-count">3</span></div>
                </div>
            </div>
            
            <div class="animation-container" id="animation-container">
                <div class="animation-items" id="animation-items"></div>
            </div>
            
            <div class="result" id="result"></div>
            
            <div class="buttons" id="buttons">
                <button class="sell-btn" onclick="sellItem()">Продать</button>
                <button class="keep-btn" onclick="keepItem()">Оставить</button>
            </div>
        </div>
        
        <div id="inventory-tab" class="tab-content">
            <h2>Ваш инвентарь</h2>
            <p id="empty-inventory" style="text-align: center; color: #aaa; display: none;">Ваш инвентарь пуст. Откройте кейсы, чтобы получить фигурки!</p>
            <div class="inventory-items" id="inventory-items">
                <!-- Здесь будут отображаться полученные фигурки -->
            </div>
        </div>
        
        <div id="upgrade-tab" class="tab-content">
            <h2>Улучшение фигурок</h2>
            <div class="upgrade-container">
                <div class="upgrade-info">
                    <h3>Как это работает?</h3>
                    <p>Выберите две фигурки одного уровня для попытки улучшения. При успехе вы получите фигурку следующего уровня, при неудаче - потеряете обе фигурки.</p>
                    <div class="progress-bar">
                        <div class="progress" id="upgrade-progress">0%</div>
                    </div>
                    <p>Шанс успеха: <span id="upgrade-chance">0</span>%</p>
                </div>
                
                <h3>Выберите фигурки для улучшения:</h3>
                <div id="upgrade-items">
                    <!-- Здесь будут фигурки для улучшения -->
                </div>
                
                <button id="perform-upgrade" class="upgrade-btn" disabled onclick="performUpgrade()">Улучшить</button>
            </div>
        </div>
    </div>
    
    <div id="upgrade-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h2 class="modal-title" id="upgrade-modal-title">Результат улучшения</h2>
            <p class="modal-text" id="upgrade-modal-text"></p>
            <div id="upgrade-modal-item"></div>
            <button class="upgrade-btn" onclick="closeModal()">OK</button>
        </div>
    </div>
    
    <div id="key-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h2 class="modal-title">🎉 Поздравляем! 🎉</h2>
            <p class="modal-text">Вы получили ключ от кейса!</p>
            <p>Теперь вы можете открыть один кейс бесплатно.</p>
            <button class="upgrade-btn" onclick="closeModal()">Отлично!</button>
        </div>
    </div>

    <script>
        // Данные о фигурках для каждого кейса
        const caseItems = [
            // Обычный кейс
            [
                { name: "Обычная фигурка 1", price: 50, image: "https://via.placeholder.com/200/aaa/000?text=Обыч1", rarity: "common", level: 1, id: 1 },
                { name: "Обычная фигурка 2", price: 70, image: "https://via.placeholder.com/200/aaa/000?text=Обыч2", rarity: "common", level: 1, id: 2 },
                { name: "Редкая фигурка 1", price: 150, image: "https://via.placeholder.com/200/4d88ff/fff?text=Редк1", rarity: "rare", level: 1, id: 3 },
                { name: "Редкая фигурка 2", price: 200, image: "https://via.placeholder.com/200/4d88ff/fff?text=Редк2", rarity: "rare", level: 1, id: 4 },
                { name: "Легендарная фигурка", price: 500, image: "https://via.placeholder.com/200/ffaa00/000?text=Легенда", rarity: "legendary", level: 1, id: 5 }
            ],
            // Редкий кейс
            [
                { name: "Редкая фигурка A", price: 200, image: "https://via.placeholder.com/200/4d88ff/fff?text=РедкA", rarity: "rare", level: 1, id: 6 },
                { name: "Редкая фигурка B", price: 250, image: "https://via.placeholder.com/200/4d88ff/fff?text=РедкB", rarity: "rare", level: 1, id: 7 },
                { name: "Эпическая фигурка X", price: 400, image: "https://via.placeholder.com/200/b347ea/fff?text=ЭпикX", rarity: "epic", level: 1, id: 8 },
                { name: "Легендарная фигурка Y", price: 800, image: "https://via.placeholder.com/200/ffaa00/000?text=ЛегендаY", rarity: "legendary", level: 1, id: 9 }
            ],
            // Эпический кейс
            [
                { name: "Эпическая фигурка 1", price: 400, image: "https://via.placeholder.com/200/b347ea/fff?text=Эпик1", rarity: "epic", level: 1, id: 10 },
                { name: "Эпическая фигурка 2", price: 600, image: "https://via.placeholder.com/200/b347ea/fff?text=Эпик2", rarity: "epic", level: 1, id: 11 },
                { name: "Легендарная фигурка Z", price: 1000, image: "https://via.placeholder.com/200/ffaa00/000?text=ЛегендаZ", rarity: "legendary", level: 1, id: 12 },
                { name: "Золотая фигурка", price: 2000, image: "https://via.placeholder.com/200/gold/000?text=Золото", rarity: "legendary", level: 1, id: 13 }
            ],
            // Легендарный кейс
            [
                { name: "Легендарная фигурка Alpha", price: 1000, image: "https://via.placeholder.com/200/ffaa00/000?text=Alpha", rarity: "legendary", level: 1, id: 14 },
                { name: "Легендарная фигурка Beta", price: 1200, image: "https://via.placeholder.com/200/ffaa00/000?text=Beta", rarity: "legendary", level: 1, id: 15 },
                { name: "Мифическая фигурка", price: 3000, image: "https://via.placeholder.com/200/ff3333/fff?text=Мифич", rarity: "legendary", level: 1, id: 16 },
                { name: "Ключ от кейса", price: 0, image: "https://via.placeholder.com/200/33cc33/fff?text=Ключ", rarity: "special", level: 0, id: 17, isKey: true }
            ]
        ];
        
        // Цены кейсов
        const casePrices = [100, 300, 500, 1000];
        
        // Ограниченное количество кейсов
        let limitedCasesLeft = 5;
        let legendaryCasesLeft = 3;
        
        // Игровые переменные
        let money = 1000;
        let openedCases = 0;
        let keys = 0;
        let inventory = [];
        let currentItem = null;
        let animationInterval = null;
        let animationSpeed = 30;
        let slowingDown = false;
        let currentPosition = 0;
        let targetPosition = 0;
        let selectedForUpgrade = [];
        
        // Обновление отображения баланса
        function updateBalance() {
            document.getElementById('money').textContent = money;
            document.getElementById('opened-cases').textContent = openedCases;
            document.getElementById('limited-count').textContent = limitedCasesLeft;
            document.getElementById('legendary-count').textContent = legendaryCasesLeft;
            document.getElementById('keys').textContent = keys;
        }
        
        // Переключение вкладок
        function openTab(tabId) {
            // Скрыть все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Убрать активный класс у всех кнопок вкладок
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показать выбранную вкладку
            document.getElementById(tabId).classList.add('active');
            
            // Сделать кнопку активной
            event.currentTarget.classList.add('active');
            
            // Если открываем вкладку улучшения, обновляем ее
            if (tabId === 'upgrade-tab') {
                updateUpgradeTab();
            }
        }
        
        // Открытие кейса
        function openCase(caseIndex) {
            // Проверка баланса и ключей
            if (money < casePrices[caseIndex] && keys === 0) {
                alert('Недостаточно средств!');
                return;
            }
            
            // Проверка ограниченных кейсов
            if (caseIndex === 2 && limitedCasesLeft <= 0) {
                alert('Эпические кейсы закончились!');
                return;
            }
            
            if (caseIndex === 3 && legendaryCasesLeft <= 0) {
                alert('Легендарные кейсы закончились!');
                return;
            }
            
            // Используем ключ если есть, иначе списываем деньги
            if (keys > 0) {
                keys--;
            } else {
                money -= casePrices[caseIndex];
            }
            
            openedCases++;
            if (caseIndex === 2) limitedCasesLeft--;
            if (caseIndex === 3) legendaryCasesLeft--;
            updateBalance();
            
            // Заблокируем кнопки кейсов на время анимации
            document.querySelectorAll('.case').forEach(c => c.style.pointerEvents = 'none');
            
            // Подготовка анимации
            prepareAnimation(caseIndex);
            
            // Запуск анимации
            startAnimation(caseIndex);
        }
        
        // Подготовка анимации
        function prepareAnimation(caseIndex) {
            const animationContainer = document.getElementById('animation-container');
            const animationItems = document.getElementById('animation-items');
            
            // Очистим предыдущие элементы
            animationItems.innerHTML = '';
            
            // Создадим много копий фигурок для анимации прокрутки
            const items = caseItems[caseIndex];
            for (let i = 0; i < 150; i++) {
                const item = items[Math.floor(Math.random() * items.length)];
                const itemElement = document.createElement('div');
                itemElement.className = 'animation-item';
                itemElement.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <div class="name">${item.name}</div>
                `;
                animationItems.appendChild(itemElement);
            }
            
            // Покажем контейнер анимации
            animationContainer.style.display = 'block';
            
            // Скрываем предыдущий результат и кнопки
            document.getElementById('result').style.display = 'none';
            document.getElementById('buttons').style.display = 'none';
        }
        
        // Запуск анимации
        function startAnimation(caseIndex) {
            const animationItems = document.getElementById('animation-items');
            const items = caseItems[caseIndex];
            
            // Вычисляем целевую позицию для остановки (случайный элемент с учетом редкости)
            let totalRarity = items.reduce((sum, item) => sum + getRarityValue(item.rarity), 0);
            let randomValue = Math.random() * totalRarity;
            let selectedItem = null;
            
            for (const item of items) {
                if (randomValue <= getRarityValue(item.rarity)) {
                    selectedItem = item;
                    break;
                }
                randomValue -= getRarityValue(item.rarity);
            }
            
            // Если почему-то не выбрали (маловероятно), берем первый
            if (!selectedItem) selectedItem = items[0];
            
            currentItem = selectedItem;
            
            // Вычисляем позицию, где этот элемент будет в центре
            const itemWidth = 185; // 180px + 5px margin-right
            const containerWidth = document.getElementById('animation-container').offsetWidth;
            const centerPosition = Math.floor(containerWidth / 2) - Math.floor(itemWidth / 2);
            
            // Находим индекс выбранного элемента в анимации (последние 30 элементов)
            const animationItemsCount = animationItems.children.length;
            const searchStart = animationItemsCount - 30;
            let targetIndex = -1;
            
            // Ищем наш выбранный предмет в последних элементах
            for (let i = searchStart; i < animationItemsCount; i++) {
                const img = animationItems.children[i].querySelector('img');
                if (img && img.alt === selectedItem.name) {
                    targetIndex = i;
                    break;
                }
            }
            
            // Если не нашли (маловероятно), берем предпоследний
            if (targetIndex === -1) targetIndex = animationItemsCount - 2;
            
            // Вычисляем целевую позицию для остановки
            targetPosition = -(targetIndex * itemWidth - centerPosition);
            
            // Начинаем анимацию
            currentPosition = 0;
            slowingDown = false;
            animationItems.style.left = currentPosition + 'px';
            
            if (animationInterval) clearInterval(animationInterval);
            
            // Добавим немного случайности в скорость анимации
            const baseSpeed = 30;
            const speedVariation = Math.random() * 20 - 10; // от -10 до +10
            animationSpeed = baseSpeed + speedVariation;
            
            animationInterval = setInterval(() => {
                // Если еще не начали замедляться и прошли 70% пути
                if (!slowingDown && currentPosition < targetPosition * 0.7) {
                    slowingDown = true;
                    animationSpeed = 150; // Замедляемся
                    
                    // Подсветим все элементы с таким же именем
                    const items = document.querySelectorAll('.animation-item');
                    items.forEach(item => {
                        const img = item.querySelector('img');
                        if (img && img.alt === selectedItem.name) {
                            item.classList.add('highlight');
                        }
                    });
                }
                
                // Двигаемся к цели
                if (slowingDown) {
                    // Приближаемся к цели с замедлением
                    const distance = targetPosition - currentPosition;
                    currentPosition += distance * 0.1;
                    
                    // Если очень близко, останавливаемся
                    if (Math.abs(distance) < 5) {
                        currentPosition = targetPosition;
                        clearInterval(animationInterval);
                        animationItems.style.left = currentPosition + 'px';
                        showResult();
                        return;
                    }
                } else {
                    // Быстрое движение в начале
                    currentPosition -= 30;
                }
                
                animationItems.style.left = currentPosition + 'px';
            }, animationSpeed);
        }
        
        // Получить числовое значение редкости
        function getRarityValue(rarity) {
            switch(rarity) {
                case 'common': return 60;
                case 'rare': return 25;
                case 'epic': return 10;
                case 'legendary': return 5;
                case 'special': return 1;
                default: return 10;
            }
        }
        
        // Показать результат
        function showResult() {
            const resultElement = document.getElementById('result');
            const buttonsElement = document.getElementById('buttons');
            
            resultElement.textContent = `🎉 Вы получили: ${currentItem.name} (${currentItem.price} ₽) 🎉`;
            resultElement.style.display = 'block';
            buttonsElement.style.display = 'flex';
            
            // Разблокируем кейсы
            document.querySelectorAll('.case').forEach(c => c.style.pointerEvents = 'auto');
            
            // Если это ключ, покажем модальное окно
            if (currentItem.isKey) {
                keys++;
                updateBalance();
                setTimeout(() => {
                    document.getElementById('key-modal').style.display = 'flex';
                }, 1000);
            }
        }
        
        // Продать предмет
        function sellItem() {
            money += currentItem.price;
            updateBalance();
            
            // Эффект продажи
            createConfetti(currentItem.rarity);
            
            hideResultElements();
        }
        
        // Оставить предмет в инвентаре
        function keepItem() {
            // Создаем копию объекта, чтобы можно было изменять level независимо
            const itemCopy = JSON.parse(JSON.stringify(currentItem));
            inventory.push(itemCopy);
            updateInventory();
            
            // Эффект получения
            createConfetti(currentItem.rarity);
            
            hideResultElements();
        }
        
        // Скрыть элементы результата
        function hideResultElements() {
            document.getElementById('animation-container').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            document.getElementById('buttons').style.display = 'none';
            
            // Убрать подсветку
            document.querySelectorAll('.animation-item').forEach(item => {
                item.classList.remove('highlight');
            });
        }
        
        // Обновление инвентаря
        function updateInventory() {
            const inventoryItems = document.getElementById('inventory-items');
            const emptyInventory = document.getElementById('empty-inventory');
            inventoryItems.innerHTML = '';
            
            if (inventory.length === 0) {
                emptyInventory.style.display = 'block';
            } else {
                emptyInventory.style.display = 'none';
                
                inventory.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.innerHTML = `
                        <div class="level">${item.level}</div>
                        <img src="${item.image}" alt="${item.name}">
                        <div class="name">${item.name}</div>
                        <div class="price">${item.price * item.level} ₽</div>
                        <div class="item-actions">
                            <button class="sell-inventory-btn" onclick="sellInventoryItem(${index})">Продать</button>
                            <button class="upgrade-inventory-btn" onclick="selectForUpgrade(${index})">Выбрать</button>
                        </div>
                    `;
                    inventoryItems.appendChild(itemElement);
                });
            }
        }
        
        // Продать предмет из инвентаря
        function sellInventoryItem(index) {
            if (index >= 0 && index < inventory.length) {
                const item = inventory[index];
                money += item.price * item.level;
                inventory.splice(index, 1);
                updateBalance();
                updateInventory();
                updateUpgradeTab();
                
                // Эффект продажи
                createConfetti(item.rarity);
            }
        }
        
        // Выбрать предмет для улучшения
        function selectForUpgrade(index) {
            if (index >= 0 && index < inventory.length) {
                const item = inventory[index];
                
                // Проверяем, не выбран ли уже этот предмет
                const alreadySelected = selectedForUpgrade.some(selected => selected.index === index);
                
                if (alreadySelected) {
                    // Убираем из выбранных
                    selectedForUpgrade = selectedForUpgrade.filter(selected => selected.index !== index);
                } else {
                    // Проверяем, можно ли добавить (максимум 2)
                    if (selectedForUpgrade.length < 2) {
                        selectedForUpgrade.push({ index, item });
                    } else {
                        alert('Можно выбрать только 2 предмета для улучшения!');
                        return;
                    }
                }
                
                updateUpgradeTab();
            }
        }
        
        // Обновление вкладки улучшения
        function updateUpgradeTab() {
            const upgradeItems = document.getElementById('upgrade-items');
            const upgradeBtn = document.getElementById('perform-upgrade');
            const upgradeProgress = document.getElementById('upgrade-progress');
            const upgradeChance = document.getElementById('upgrade-chance');
            
            upgradeItems.innerHTML = '';
            
            if (selectedForUpgrade.length === 0) {
                upgradeBtn.disabled = true;
                upgradeProgress.style.width = '0%';
                upgradeProgress.textContent = '0%';
                upgradeChance.textContent = '0';
                return;
            }
            
            // Отображаем выбранные предметы
            selectedForUpgrade.forEach((selected, i) => {
                const item = selected.item;
                const itemElement = document.createElement('div');
                itemElement.className = 'upgrade-item';
                itemElement.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <div class="upgrade-item-info">
                        <div class="upgrade-item-name">${item.name}</div>
                        <div class="upgrade-item-stats">
                            <span class="upgrade-item-price">${item.price * item.level} ₽</span>
                            <span> • Ур. ${item.level}</span>
                        </div>
                        <div>Редкость: <span class="rarity-${item.rarity}">${getRarityName(item.rarity)}</span></div>
                    </div>
                    <button onclick="selectForUpgrade(${selected.index})">✕</button>
                `;
                upgradeItems.appendChild(itemElement);
            });
            
            // Проверяем, можно ли выполнить улучшение
            let canUpgrade = true;
            let chance = 0;
            let baseLevel = 0;
            
            if (selectedForUpgrade.length === 2) {
                const item1 = selectedForUpgrade[0].item;
                const item2 = selectedForUpgrade[1].item;
                
                // Проверяем, что уровни одинаковые
                if (item1.level !== item2.level) {
                    canUpgrade = false;
                } else {
                    baseLevel = item1.level;
                    
                    // Рассчитываем шанс улучшения
                    const rarity1 = getRarityValue(item1.rarity);
                    const rarity2 = getRarityValue(item2.rarity);
                    
                    // Базовый шанс зависит от редкости предметов и их уровня
                    chance = Math.min(90, 50 + (100 - (rarity1 + rarity2)/2) - (baseLevel * 10));
                }
            } else {
                canUpgrade = false;
            }
            
            upgradeBtn.disabled = !canUpgrade;
            
            if (canUpgrade) {
                upgradeProgress.style.width = `${chance}%`;
                upgradeProgress.textContent = `${chance}%`;
                upgradeChance.textContent = chance;
            } else {
                upgradeProgress.style.width = '0%';
                upgradeProgress.textContent = '0%';
                upgradeChance.textContent = '0';
            }
        }
        
        // Получить название редкости
        function getRarityName(rarity) {
            switch(rarity) {
                case 'common': return 'Обычная';
                case 'rare': return 'Редкая';
                case 'epic': return 'Эпическая';
                case 'legendary': return 'Легендарная';
                case 'special': return 'Особая';
                default: return 'Неизвестная';
            }
        }
        
        // Выполнить улучшение
        function performUpgrade() {
            if (selectedForUpgrade.length !== 2) return;
            
            const index1 = selectedForUpgrade[0].index;
            const index2 = selectedForUpgrade[1].index;
            const item1 = inventory[index1];
            const item2 = inventory[index2];
            
            // Проверяем, что предметы еще существуют (не были проданы и т.д.)
            if (!item1 || !item2 || item1.level !== item2.level) {
                alert('Ошибка при улучшении!');
                selectedForUpgrade = [];
                updateUpgradeTab();
                return;
            }
            
            const baseLevel = item1.level;
            
            // Рассчитываем шанс улучшения
            const rarity1 = getRarityValue(item1.rarity);
            const rarity2 = getRarityValue(item2.rarity);
            const chance = Math.min(90, 50 + (100 - (rarity1 + rarity2)/2) - (baseLevel * 10));
            
            // Определяем результат
            const success = Math.random() * 100 < chance;
            
            // Удаляем использованные предметы
            if (index1 > index2) {
                inventory.splice(index1, 1);
                inventory.splice(index2, 1);
            } else {
                inventory.splice(index2, 1);
                inventory.splice(index1, 1);
            }
            
            if (success) {
                // Создаем улучшенный предмет
                const upgradedItem = {
                    ...item1,
                    level: baseLevel + 1,
                    price: Math.floor(item1.price * 1.5)
                };
                
                inventory.push(upgradedItem);
                
                // Показываем результат
                showUpgradeResult(true, upgradedItem);
            } else {
                // Показываем неудачу
                showUpgradeResult(false);
            }
            
            // Обновляем интерфейс
            selectedForUpgrade = [];
            updateInventory();
            updateUpgradeTab();
        }
        
        // Показать результат улучшения
        function showUpgradeResult(success, upgradedItem = null) {
            const modal = document.getElementById('upgrade-modal');
            const title = document.getElementById('upgrade-modal-title');
            const text = document.getElementById('upgrade-modal-text');
            const itemContainer = document.getElementById('upgrade-modal-item');
            
            if (success) {
                title.textContent = '🎉 Улучшение успешно! 🎉';
                text.textContent = `Вы получили предмет ${upgradedItem.name} уровня ${upgradedItem.level}!`;
                
                itemContainer.innerHTML = `
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="position: relative; display: inline-block;">
                            <img src="${upgradedItem.image}" alt="${upgradedItem.name}" 
                                 style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #ffcc00;">
                            <div style="position: absolute; top: -10px; left: -10px; background-color: #ffcc00; color: #333; 
                                       width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; 
                                       justify-content: center; font-weight: bold;">${upgradedItem.level}</div>
                        </div>
                        <div style="margin-top: 10px; font-weight: bold;">${upgradedItem.name}</div>
                        <div style="color: #ffcc00; font-weight: bold;">${upgradedItem.price * upgradedItem.level} ₽</div>
                    </div>
                `;
                
                // Эффект успеха
                for (let i = 0; i < 100; i++) {
                    createConfetti(upgradedItem.rarity);
                }
            } else {
                title.textContent = '😢 Улучшение не удалось 😢';
                text.textContent = 'К сожалению, улучшение не удалось. Вы потеряли оба предмета.';
                itemContainer.innerHTML = '';
                
                // Эффект неудачи
                createConfetti('common', 30, '#ff3333');
            }
            
            modal.style.display = 'flex';
        }
        
        // Закрыть модальное окно
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
        
        // Создать конфетти
        function createConfetti(rarity, count = 50, color = null) {
            if (!color) {
                switch(rarity) {
                    case 'common': color = '#aaa'; break;
                    case 'rare': color = '#4d88ff'; break;
                    case 'epic': color = '#b347ea'; break;
                    case 'legendary': color = '#ffaa00'; break;
                    case 'special': color = '#33cc33'; break;
                    default: color = '#ffcc00';
                }
            }
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = color;
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = Math.random() * 10 + 5 + 'px';
                confetti.style.animationDuration = Math.random() * 3 + 2 + 's';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                document.body.appendChild(confetti);
                
                // Удаляем конфетти после анимации
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }
        
        // Инициализация
        updateBalance();
        updateInventory();
        
        // Пример добавления нескольких предметов в инвентарь для тестирования
        // inventory.push(...[
        //     { name: "Обычная фигурка 1", price: 50, image: "https://via.placeholder.com/200/aaa/000?text=Обыч1", rarity: "common", level: 1, id: 1 },
        //     { name: "Обычная фигурка 1", price: 50, image: "https://via.placeholder.com/200/aaa/000?text=Обыч1", rarity: "common", level: 1, id: 1 },
        //     { name: "Редкая фигурка 1", price: 150, image: "https://via.placeholder.com/200/4d88ff/fff?text=Редк1", rarity: "rare", level: 1, id: 3 },
        //     { name: "Редкая фигурка 1", price: 150, image: "https://via.placeholder.com/200/4d88ff/fff?text=Редк1", rarity: "rare", level: 1, id: 3 }
        // ]);
        // updateInventory();
    </script>
</body>
</html>
